name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 1,16 * *" # Every 15 days: 1st and 16th of each month at midnight

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Cache uv
        id: cache-uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}

      - name: Set up uv
        id: setup-uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        id: setup-python
        run: uv python install 3.11

      - name: Install dependencies
        id: install-dependencies
        run: uv sync --dev --extra dev

      - name: Run Bandit security check
        id: run-bandit
        run: uv run bandit -r src/

      - name: Check package vulnerabilities
        id: check-vulnerabilities
        env:
          SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
        run: uv run safety scan

      - name: Check for outdated packages
        id: check-outdated
        run: uv run pip list --outdated
